<template>
  <v-card class="details-card" translate="no">
    <v-card-title class="d-flex justify-space-between align-center">
      <div class="d-flex align-center flex-grow-1">
        <v-chip color="primary" label>
          {{ trackData.site }} {{ trackData.day }}
        </v-chip>
      </div>
      <div class="text-right flex-grow-1">
        {{ $gettext('Flight Details') }}
      </div>
    </v-card-title>
    <v-tabs v-model="tab" color="primary" class="bg-grey-lighten-4">
      <v-tab value="about">
        <v-icon class="mr-2">mdi-information-outline</v-icon>
        {{ $gettext('About') }}
      </v-tab>
      <v-tab value="comment">
        <v-icon class="mr-2">mdi-comment-text-outline</v-icon>
        {{ $gettext('Comment') }}
      </v-tab>
      <v-tab value="modify">
        <v-icon class="mr-2">mdi-pencil-outline</v-icon>
        {{ $gettext('Modify') }}
      </v-tab>
      <v-tab value="share">
        <v-icon class="mr-2">mdi-share-variant-outline</v-icon>
        {{ $gettext('Share') }}
      </v-tab>
      <v-tab value="more">
        <v-icon class="mr-2">mdi-dots-horizontal</v-icon>
        {{ $gettext('More') }}...
      </v-tab>
    </v-tabs>

    <v-window v-model="tab">
      <v-window-item value="about">
        <v-card-text>
          <div class="about-block">
            <!--
            <div class="about-row tag-row">
              <span class="tag-label">{{ trackData?.tagLabel || 'Une ligne pour le libellé éventuel du tag' }}</span>
            </div>-->
            <div class="about-row info-row">
              <span class="info-bold">{{ $gettext('Site') }}</span>
              <span>{{ trackData?.site || '' }}</span>
              <span class="info-bold">{{ $gettext('Glider') }}</span>
              <span>{{ trackData?.glider || '' }}</span>
              <span class="info-bold">{{ $gettext('Pilot') }}</span>
              <span>{{ trackData?.decodedIgc.info.pilot || '' }}</span>
            </div>
            <div class="about-row info-row">
              <span class="info-bold">{{ $gettext('Take off') }} :</span> <span>{{ timeTakeOff }}</span>
              <span class="info-bold">{{ $gettext('Landing') }} :</span> <span>{{ timeLanding }}</span>
              <span class="info-bold">{{ $gettext('Duration') }} :</span> <span>{{ trackData?.duration || '' }}</span>
            </div>
            <div class="about-row info-row">
              <span class="info-bold">{{ $gettext('Max GPS alt') }} :</span> <span>{{
                trackData?.decodedIgc.stat.maxalt.gps || '' }}m</span>
              <span class="info-bold">{{ $gettext('Max climb') }} :</span> <span>{{ trackData?.decodedIgc.stat.maxclimb
                || '' }}m/s</span>
              <span class="info-bold">{{ $gettext('Max sink') }} :</span> <span>{{ trackData?.decodedIgc.stat.maxsink ||
                '' }}m/s</span>
            </div>
            <div class="about-row info-row">
              <v-btn color="success" density="compact" @click="showScoreDialog = true" :disabled="isComputingScore"
                class="ml-2">
                {{ isComputingScore ? 'Computing...' : 'Scoring' }}
              </v-btn>
              <span class="info-bold">{{ scoreLabel }}</span>
            </div>
            <ScoreDialog v-model="showScoreDialog" @select="onScoreSelected" />
            <div class="about-row btn-row">
              <v-btn color="primary" density="compact" class="mr-2">{{ $gettext('Add photo') }}</v-btn>
              <v-btn color="error" density="compact">{{ $gettext('Remove photo') }}</v-btn>
            </div>
          </div>
        </v-card-text>
      </v-window-item>

      <v-window-item value="comment">
        <v-card-text>
          <v-textarea v-model="commentText" :label="$gettext('Add a comment')" rows="5" variant="outlined"
            density="compact"></v-textarea>
          <div class="comment-btn-row">
            <v-btn color="error" density="compact" class="mr-2" @click="onDeleteComment">{{ $gettext('Delete') }}</v-btn>
            <v-btn color="primary" density="compact" @click="onValidateComment">{{ $gettext('OK') }}</v-btn>
          </div>
        </v-card-text>
      </v-window-item>

      <v-window-item value="modify">
        <v-card-text>
          <div class="modify-btn-row">
            <div class="modify-line">
              <v-btn color="primary" density="compact" class="mr-2" @click="showGliderDialog = true">{{ $gettext('Change glider') }}</v-btn>
              <GliderDialog v-model="showGliderDialog" :gliderList="gliderList" :currentGlider="trackData?.glider"
                @save="onGliderSave" />
              <v-btn color="primary" density="compact" @click="showSiteDialog = true">{{ $gettext('Change site') }}</v-btn>
              <ChangeSiteDialog v-model="showSiteDialog" :siteList="siteList" :currentSite="trackData?.site"
                @save="onSiteSave" />
            </div>
            <div class="modify-line">
              <v-btn color="error" density="compact">{{ $gettext('Delete') }}</v-btn>
            </div>
            <div class="modify-line">
              <v-btn color="warning" density="compact" class="mr-2">{{ $gettext('Edit/Duplicate') }}</v-btn>
              <v-btn color="secondary" density="compact">{{ $gettext('Merge flights') }}</v-btn>
            </div>
          </div>
        </v-card-text>
      </v-window-item>

      <v-window-item value="share">
        <v-card-text>
          Options de partage...
        </v-card-text>
      </v-window-item>

      <v-window-item value="more">
        <v-card-text>
          Autres options...
        </v-card-text>
      </v-window-item>
    </v-window>
  </v-card>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import { useGettext } from "vue3-gettext";
import { igcScoring } from '@/js/igc/igc-scoring';
import ScoreDialog from '@/components/ScoreDialog.vue';
import GliderDialog from '@/components/GliderDialog.vue';
import ChangeSiteDialog from '@/components/ChangeSiteDialog.vue';
import { useDatabaseStore } from '@/stores/database';

const databaseStore = useDatabaseStore();
const { $gettext } = useGettext();

const showGliderDialog = ref(false);
const showSiteDialog = ref(false);
const gliderList = ref([]);
const siteList = ref([]);
const tab = ref('about'); // Onglet "About" sélectionné par défaut
const isComputingScore = ref(false);
const showScoreDialog = ref(false);
const scoreJson = ref(null);
const scoreLabel = ref('');
const commentText = ref('');

const props = defineProps({
  trackData: {
    type: Object,
    default: null
  }
});

const emit = defineEmits(['update:scoreJson', 'update:comment', 'update:glider', 'update:site']);


function loadGliderList() {
  const reqSQL = "SELECT DISTINCT V_Engin FROM Vol WHERE V_Engin IS NOT NULL AND V_Engin != '' ORDER BY upper(V_Engin)";
  const result = databaseStore.query(reqSQL);
  if (result.success && result.data && result.data[0]) {
    const values = result.data[0].values;
    gliderList.value = values.map(row => row[0]);
  } else {
    gliderList.value = [];
  }
}

function loadSiteList() {
  const reqSQL = "SELECT S_ID, S_Nom, S_Localite FROM Site WHERE S_Type = 'D' ORDER BY S_Nom";
  const result = databaseStore.query(reqSQL);
  if (result.success && result.data && result.data[0]) {
    const columns = result.data[0].columns;
    const values = result.data[0].values;
    siteList.value = values.map(row => {
      const obj = {};
      columns.forEach((col, idx) => {
        obj[col] = row[idx];
      });
      return obj;
    });
  } else {
    siteList.value = [];
  }
}

// Met à jour le commentaire affiché à chaque changement de vol
watch(() => props.trackData, (newVal) => {
  scoreLabel.value = '';
  commentText.value = newVal?.comment || '';
});

// Charger la liste des voiles à l'ouverture du dialog
watch(showGliderDialog, (val) => { if (val) loadGliderList(); });
watch(showSiteDialog, (val) => { if (val) loadSiteList(); });

function onGliderSave(newGlider) {
  // Remonte la valeur au parent (LogbookView) pour traitement
  emit('update:glider', {
    id: props.trackData?.dbId || null,
    glider: newGlider
  });
}

function onSiteSave(newSite) {
  emit('update:site', {
    id: props.trackData?.dbId || null,
    site: newSite
  });
}




function onDeleteComment() {
  commentText.value = '';
  onValidateComment();
}

function onValidateComment() {
  // On émet l'ID du vol et le commentaire courant
  console.log('Emitting comment update:', props.trackData?.dbId || null)
  emit('update:comment', {
    id: props.trackData?.dbId || null,
    comment: commentText.value
  });
}

const timeTakeOff = computed(() => {
  const feature = props.trackData?.decodedIgc?.GeoJSON?.features[0];
  if (!feature || !feature.properties.coordTimes || feature.properties.coordTimes.length === 0) {
    return '';
  }
  const dateTkoff = new Date(feature.properties.coordTimes[0]) // to get local time   
  return dateTkoff.getUTCHours().toString().padStart(2, '0') + ':' + dateTkoff.getUTCMinutes().toString().padStart(2, '0');
});

const timeLanding = computed(() => {
  const feature = props.trackData?.decodedIgc?.GeoJSON?.features[0];
  if (!feature || !feature.properties.coordTimes || feature.properties.coordTimes.length === 0) {
    return '';
  }
  const dateLanding = new Date(feature.properties.coordTimes[feature.properties.coordTimes.length - 1])
  return dateLanding.getUTCHours().toString().padStart(2, '0') + ':' + dateLanding.getUTCMinutes().toString().padStart(2, '0');
});

const trackFixes = computed(() => {
  return props.trackData?.decodedIgc?.fixes || [];
});

const trackDate = computed(() => {
  return props.trackData?.decodedIgc?.info?.date || '';
});

function onScoreSelected(league) {
  computeScore(league);
}

async function computeScore(league) {
  if (isComputingScore.value) return; // Évite les clics multiples
  if (!trackFixes.value || trackFixes.value.length === 0) {
    console.warn('Pas de fixes disponibles pour le calcul du score');
    return;
  }
  if (!trackDate.value) {
    console.warn('Pas de date disponible pour le calcul du score');
    return;
  }
  isComputingScore.value = true;
  try {
    const result = await igcScoring({
      date: trackDate.value,
      fixes: trackFixes.value,
      league: league
    });
    if (result.success) {
      scoreJson.value = result.geojson;
      const strScore = JSON.parse(JSON.stringify(result.geojson))
      const sc_league = strScore.league
      const sc_best = strScore.score + ' pts'
      const sc_course = strScore.course
      const sc_distance = strScore.distance + ' km'
      const sc_multi = strScore.multiplier
      // Score computed: League=FFVL, Score=34.64 pts, Course=Triangle plat, Distance=28.87 km, Multiplier=1.2
      scoreLabel.value = `${sc_league} : ${sc_course} Distance ${sc_distance}   Score ${sc_best} Coeff =${sc_multi}`;
      // Informer le parent (LogbookView)du nouveau score calculé
      emit('update:scoreJson', result.geojson);
      return result.geojson;
    } else {
      console.error('Erreur scoring:', result.message);
    }
  } catch (error) {
    console.error('Erreur lors du calcul du score:', error);
  } finally {
    isComputingScore.value = false;
  }
}

function formatDuration(seconds) {
  if (!seconds) return 'N/A';
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  return `${hours}h ${minutes}min`;
}
</script>

<style scoped>
.details-card {
  height: 100%;
  display: flex;
  flex-direction: column;
  border-radius: 10px;
}

.details-card :deep(.v-card) {
  border-radius: 0;
  box-shadow: none;
}

.track-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 8px 0;
}

.info-row {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  align-items: center;
  padding: 8px 12px;
  background: #f5f5f5;
  border-radius: 4px;
}

.label {
  font-weight: 500;
  color: #666;
}

.value {
  font-weight: 600;
  color: #333;
}

.no-data {
  color: #999;
  font-style: italic;
  text-align: center;
  padding: 40px 20px;
}

.about-block {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 10px;
}

.about-row {
  display: flex;
  align-items: center;
  padding: 4px 4px;
  background: #f5f5f5;
  border-radius: 4px;
}

.tag-row {
  font-size: 1.1em;
  margin-bottom: 4px;
}

.tag-label {
  font-weight: 400;
}

.info-bold {
  font-weight: 600;
}

.btn-row {
  display: flex;
  gap: 16px;
  margin-top: 10px;
}

.modify-btn-row {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 10px;
}

.modify-line {
  display: flex;
  flex-direction: row;
  gap: 12px;
}

.comment-btn-row {
  display: flex;
  gap: 12px;
  margin-top: 10px;
  justify-content: flex-end;
}

.compute-btn {
  padding: 6px 16px;
  margin-left: 16px;
  background-color: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  text-transform: uppercase;
  transition: background-color 0.2s;
}

.compute-btn:hover:not(:disabled) {
  background-color: #45a049;
}

.compute-btn:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
}
</style>
